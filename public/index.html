<!DOCTYPE html>
<html>
<head>
    <title>TalkHub - Hateem</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; margin: 0; }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; padding: 20px; }
        video { width: 100%; border-radius: 10px; border: 2px solid cyan; background: black; }
        .controls { padding: 20px; background: #222; position: sticky; top: 0; z-index: 100; }
        button { padding: 10px 20px; margin: 5px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-on { background: cyan; }
        .btn-off { background: #ff4444; color: white; }
    </style>
</head>
<body>
    <div class="controls">
        <h2>TalkHub ðŸš€</h2>
        <button id="cam-btn" class="btn-on" onclick="toggleVideo()">ðŸŽ¥ Cam: ON</button>
        <button id="mic-btn" class="btn-on" onclick="toggleAudio()">ðŸŽ¤ Mic: ON</button>
        <button class="btn-on" style="background:orange" onclick="shareScreen()">ðŸ–¥ Share Screen</button>
    </div>
    <div id="video-grid"></div>

<script>
    const socket = io('/');
    const videoGrid = document.getElementById('video-grid');
    const myPeer = new Peer(); // Handles the video connections
    const myVideo = document.createElement('video');
    myVideo.muted = true; // Mute yourself so you don't hear your own echo
    const peers = {};
    let myStream;

    // 1. Get Camera and Mic
    navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
    }).then(stream => {
        myStream = stream;
        addVideoStream(myVideo, stream);

        // 2. Answer incoming calls
        myPeer.on('call', call => {
            call.answer(stream);
            const video = document.createElement('video');
            call.on('stream', userVideoStream => {
                addVideoStream(video, userVideoStream);
            });
        });

        // 3. Listen for new users connecting
        socket.on('user-connected', userId => {
            connectToNewUser(userId, stream);
        });
    });

    // 4. Handle user disconnecting
    socket.on('user-disconnected', userId => {
        if (peers[userId]) peers[userId].close();
    });

    // 5. Tell server we joined
    myPeer.on('open', id => {
        socket.emit('join-room', 'hateem-room', id);
    });

    function connectToNewUser(userId, stream) {
        const call = myPeer.call(userId, stream);
        const video = document.createElement('video');
        call.on('stream', userVideoStream => {
            addVideoStream(video, userVideoStream);
        });
        call.on('close', () => { video.remove(); });
        peers[userId] = call;
    }

    function addVideoStream(video, stream) {
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => { video.play(); });
        videoGrid.append(video);
    }

    // --- Controls ---
    function toggleVideo() {
        const enabled = myStream.getVideoTracks()[0].enabled;
        myStream.getVideoTracks()[0].enabled = !enabled;
        document.getElementById('cam-btn').innerText = !enabled ? "ðŸŽ¥ Cam: ON" : "ðŸŽ¥ Cam: OFF";
        document.getElementById('cam-btn').className = !enabled ? "btn-on" : "btn-off";
    }

    function toggleAudio() {
        const enabled = myStream.getAudioTracks()[0].enabled;
        myStream.getAudioTracks()[0].enabled = !enabled;
        document.getElementById('mic-btn').innerText = !enabled ? "ðŸŽ¤ Mic: ON" : "ðŸŽ¤ Mic: OFF";
        document.getElementById('mic-btn').className = !enabled ? "btn-on" : "btn-off";
    }

    async function shareScreen() {
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        myVideo.srcObject = screenStream;
        // In a real app, you'd update Peer connections here too!
    }
</script>
</body>
</html>